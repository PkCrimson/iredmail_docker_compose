# iredmail_docker_compose
Deploying iRedMail through Docker compose and implement cert from Let's Encrypt

# Image
https://hub.docker.com/r/iredmail/mariadb

# Quick start
Create a docker environment file used to store custom settings:
```
mkdir /iredmail         # Create a new directory or use any directory
                        # you prefer. `/iredmail/` is just an example
cd /iredmail
touch iredmail-docker.conf

echo HOSTNAME=mail.mydomain.com >> iredmail-docker.conf
echo FIRST_MAIL_DOMAIN=mydomain.com >> iredmail-docker.conf
echo FIRST_MAIL_DOMAIN_ADMIN_PASSWORD=my-secret-password >> iredmail-docker.conf
echo MLMMJADMIN_API_TOKEN=$(openssl rand -base64 32) >> iredmail-docker.conf
echo ROUNDCUBE_DES_KEY=$(openssl rand -base64 24) >> iredmail-docker.conf
```
Create required directories to store application data:
```
cd /iredmail
mkdir -p data/{backup-mysql,clamav,custom,imapsieve_copy,mailboxes,mlmmj,mlmmj-archive,mysql,sa_rules,ssl,postfix_queue}
```
Launch the container:
```
version: '3'

services:
  iredmail:
    image: iredmail/mariadb:stable
    container_name: iredmail
    privileged: true
    environment:
      - MAIL_THE_TIP_FILE=NO
      - HOSTNAME=mail.mydomain.com
      - FIRST_MAIL_DOMAIN=mydomain.com
      - FIRST_MAIL_DOMAIN_ADMIN_PASSWORD='your_passwords'
      - MLMMJADMIN_API_TOKEN='copy_from_iredmail-docker.conf'
      - ROUNDCUBE_DES_KEY='copy_from_iredmail-docker.conf'
      - MYSQL_ROOT_PASSWORD='your_passwords'
    hostname: mail.mydomain.com
    ports:
      - "80:80"
      - "443:443"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
      - "25:25"
      - "465:465"
      - "587:587"
    volumes:
      - /iredmail/data/backup-mysql:/var/vmail/backup/mysql
      - /iredmail/data/mailboxes:/var/vmail/vmail1
      - /iredmail/data/mlmmj:/var/vmail/mlmmj
      - /iredmail/data/mlmmj-archive:/var/vmail/mlmmj-archive
      - /iredmail/data/imapsieve_copy:/var/vmail/imapsieve_copy
      - /iredmail/data/custom:/opt/iredmail/custom
      - /iredmail/data/ssl:/opt/iredmail/ssl
      - /iredmail/data/mysql:/var/lib/mysql
      - /iredmail/data/clamav:/var/lib/clamav
      - /iredmail/data/sa_rules:/var/lib/spamassassin
      - /iredmail/data/postfix_queue:/var/spool/postfix
      - iredmail-nginx:/etc/nginx
volumes:
  iredmail-nginx:
```
Then stop and remove the container:
```
docker stop iredmail
docker remove iredmail
```
# Request a free cert from Let's Encrypt
- Install the certbot package first:

  - on CentOS/Rocky/AlmaLinux: `yum install -y certbot` (offered by EPEL repo)
  - on Debian/Ubuntu: `apt install -y certbot`
- Let's Encrypt has request rate limit control, you can request limited times for same domain in one day, but the verification process doesn't have such limit. We suggest run verification process first to make sure we fully match its requirements.

Run command below as root user to verify the request process with --dry-run argument. It will print some text on console to ask you few simple questions, please read carefully and answer them.
```
certbot certonly --webroot --dry-run -w /var/www/html -d mail.mydomain.com
```
If everything went well and no error was reported by certbot program on console, that means we fully match the requirements, and it's ok to actually request the cert by running above command again but without --dry-run argument:
```
certbot certonly --webroot -w /var/www/html -d mail.mydomain.com
```
If the command finished successfully, it will create and store cert files under `/etc/letsencrypt/live/mail.mydomain.com/` (You may have different host name instead of `mail.mydomain.com` in this sample path).

# Use Let's Encrypt cert
Backup the default generated key
```
mkdir /iredmail/default_key

cp /iredmail/data/ssl/cert.pem /iredmail/default_key
cp /iredmail/data/ssl/combined.pem /iredmail/default_key
cp /iredmail/data/ssl/key.pem /iredmail/default_key/d_key.pem   # Rename it, which will be used later
```

The easiest and quickest way to use Let's Encrypt cert is creating symbol links to the self-signed SSL cert generated by iRedMail installer.
```
ln -s /etc/letsencrypt/live/mail.mydomain.com/fullchain.pem /iredmail/data/ssl/cert.pem
ln -s /etc/letsencrypt/live/mail.mydomain.com/privkey.pem /iredmail/data/ssl/key.pem
```
Copy the default private key to mounted file
```
cp /iredmail/default_key/d_key.pem /iredmail/data/ssl
```

# Modify Nginx config
Go to the volumes created
```
cd /var/lib/docker/volumes/ired_mail_iredmail-nginx/_data/templates #Depends on where your docker installed
```
Edit the variable `ssl_certificate_key` in `ssl.tmpl` file
```
ssl_certificate_key /opt/iredmail/ssl/d_key.pem;
```
Then launch the container again, and add new `volumes`
```
version: '3'

services:
  iredmail:
    image: iredmail/mariadb:stable
    container_name: iredmail
    privileged: true

    environment:
      - MAIL_THE_TIP_FILE=NO
      - HOSTNAME=mail.esg-tec.com
      - FIRST_MAIL_DOMAIN=esg-tec.com
      - FIRST_MAIL_DOMAIN_ADMIN_PASSWORD=Xinics@510
      - MLMMJADMIN_API_TOKEN=LokOV6NfQJ8gGOxKUWV6nwTvIsmrqz7BHYr4H9i5zs8=
      - ROUNDCUBE_DES_KEY=y1DrYyTl0TLtNeh50X26l8YcpEnCNIbm
      - MYSQL_ROOT_PASSWORD=Xinics@510
    hostname: mail.esg-tec.com
    ports:
      - "80:80"
      - "443:443"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
      - "25:25"
      - "465:465"
      - "587:587"
    volumes:
      - /home/iredmail/data/backup-mysql:/var/vmail/backup/mysql
      - /home/iredmail/data/mailboxes:/var/vmail/vmail1
      - /home/iredmail/data/mlmmj:/var/vmail/mlmmj
      - /home/iredmail/data/mlmmj-archive:/var/vmail/mlmmj-archive
      - /home/iredmail/data/imapsieve_copy:/var/vmail/imapsieve_copy
      - /home/iredmail/data/custom:/opt/iredmail/custom
      - /home/iredmail/data/ssl:/opt/iredmail/ssl
      - /home/iredmail/data/mysql:/var/lib/mysql
      - /home/iredmail/data/clamav:/var/lib/clamav
      - /home/iredmail/data/sa_rules:/var/lib/spamassassin
      - /home/iredmail/data/postfix_queue:/var/spool/postfix
      - /etc/letsencrypt/live/mail.mydomain.com:/etc/letsencrypt/live/mail.mydomain.com # New Added
      - /etc/letsencrypt/archive/mail.mydomain.com:/etc/letsencrypt/archive/mail.mydomain.com # New Added
      - iredmail-nginx:/etc/nginx

volumes:
  iredmail-nginx:
```
You can access the Roundcube and admin dashboard throuh:
```
https://mail.mydomain.com #Roundcube
https://mail.mydomain.com/iredadmin #admin dashboard
```
# Configurate the DNS record 
To successfully send email, you still need to configurate the DNS record
Reference:  https://docs.iredmail.org/setup.dns.html
# Configure mail client applications
Quick MUA Settings
- Login username of SMTP/POP3/IMAP services must be full email address.
  - POP3 service: port 110 over STARTTLS, or port 995 with SSL.
  - IMAP service: port 143 over STARTTLS, or port 993 with SSL.
  - SMTP service: port 587 over STARTTLS, or port 465 with SSL.
  - CalDAV and CardDAV server addresses: https://<server>/SOGo/dav/<full email address>
Reference: https://docs.iredmail.org/

